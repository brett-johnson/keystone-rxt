# Plugin Installation

Install the plugin, given this is a POC and has no versions, you will need to export the PBR version before installing.

```shell
export PBR_VERSION=0
```

Now pip install the plugin.

``` shell
pip install --force --upgrade .
```

Once the plugin is installed, update your `keystone.conf` to use the new method named `rxt`.

The configuration file entry will look something like this

``` conf
[auth]
methods = rxt,password,token,application_credential
```

# Identity mapping, project, and domain setup

After the configuration edit, restart keystone.


``` shell
openstack identity provider create --remote-id rackspace rackspace
```

``` shell
openstack mapping create --rules files/mapping.json rackspace_mapping
```

``` shell
openstack group create rackspace_cloud_users
```

``` shell
openstack project create rackspace_cloud_project
```

``` shell
openstack role add --group rackspace_cloud_users --project rackspace_cloud_project member
```

``` shell
openstack federation protocol create rackspace --mapping rackspace_mapping --identity-provider rackspace
```

# Usage
``` shell
curl -H "Content-Type: application/json" \
  -d '{ "auth": {
    "identity": {
      "methods": ["rxt"],
      "rxt": {
        "user": {
          "name": "$RACKSPACE_USERNAME",
          "apikey": "$RACKSPACE_APIKEY"
        }
      }
    }
  }
}' "http://localhost:5000/v3/auth/tokens" | python3 -m json.tool
```

The above command will return an unscoped token which will look like so.

```json
{
    "token": {
        "methods": [
            "rxt"
        ],
        "user": {
            "domain": {
                "id": "d73da0bfedcf41da905793a197a7ebe9",
                "name": "d73da0bfedcf41da905793a197a7ebe9"
            },
            "id": "15ec0aab1d4d1c1597797ebb5be769dc0a1c0229a82edc2ee69eedc38f136cff",
            "name": "keviXXXX",
            "OS-FEDERATION": {
                "groups": [
                    {
                        "id": "67756f3053c6432fbcfa35f169e4b469"
                    }
                ],
                "identity_provider": {
                    "id": "rackspace"
                },
                "protocol": {
                    "id": "rackspace"
                }
            }
        },
        "audit_ids": [
            "S7m_sfQNQ56q4VWyDqrxpQ"
        ],
        "expires_at": "2023-09-27T10:51:51.000000Z",
        "issued_at": "2023-09-26T22:51:51.000000Z"
    }
}
```

After the initial authentication, the user will be dynamically mapped and can be managed by an admin.

``` shell
openstack user show keviXXXX
+---------------------+------------------------------------------------------------------+
| Field               | Value                                                            |
+---------------------+------------------------------------------------------------------+
| domain_id           | d73da0bfedcf41da905793a197a7ebe9                                 |
| email               | kevin.carter@rackspace.com                                       |
| enabled             | True                                                             |
| id                  | xxxxx                                                            |
| name                | keviXXXX                                                         |
| options             | {}                                                               |
| password_expires_at | None                                                             |
+---------------------+------------------------------------------------------------------+
```

Furthermore, we can investigate the domain to see that it was dynamically generated by our `rxt` federation plugin.

``` shell
openstack domain show d73da0bfedcf41da905793a197a7ebe9
+-------------+------------------------------------------------------------------+
| Field       | Value                                                            |
+-------------+------------------------------------------------------------------+
| description | Auto generated federated domain for Identity Provider: rackspace |
| enabled     | True                                                             |
| id          | d73da0bfedcf41da905793a197a7ebe9                                 |
| name        | d73da0bfedcf41da905793a197a7ebe9                                 |
| options     | {}                                                               |
| tags        | []                                                               |
+-------------+------------------------------------------------------------------+
```
